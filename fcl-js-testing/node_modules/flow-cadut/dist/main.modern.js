import{config as e}from"@onflow/config";import*as t from"@onflow/types";import*as n from"@onflow/fcl";import{config as r,send as o,getBlock as a,decode as s,getEventsAtBlockHeightRange as c}from"@onflow/fcl";import{ec as i}from"elliptic";import{SHA3 as u}from"sha3";function l(){return(l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}const d={emulator:{FungibleToken:"0xee82856bf20e2aa6",FlowFees:"0xe5a8b7f23e8b548f",FlowStorageFees:"0xf8d6e0586b0a20c7",FlowToken:"0x0ae53cb6e3f42a79"},testnet:{FungibleToken:"0x9a0766d93b6608b7",NonFungibleToken:"0x631e88ae7f1d7c20",FlowClusterQC:"0x9eca2b38b18b5dfe",FlowDKG:"0x9eca2b38b18b5dfe",FlowEpoch:"0x9eca2b38b18b5dfe",FlowIDTableStaking:"0x9eca2b38b18b5dfe",FlowToken:"0x7e60df042a9c0868",LockedTokens:"0x95e019a17d0e23d7",StakingProxy:"0x7aad92e5a0715d21",FlowStakingCollection:"0x95e019a17d0e23d7",FUSD:"0xe223d8a629e49c68"},mainnet:{FungibleToken:"0xf233dcee88fe0abe",NonFungibleToken:"0x1d7e57aa55817448",FlowClusterQC:"0x8624b52f9ddcd04a",FlowDKG:"0x8624b52f9ddcd04a",FlowEpoch:"0x8624b52f9ddcd04a",FlowIDTableStaking:"0x8624b52f9ddcd04a",FlowFees:"0xf919ee77447b7497",FlowToken:"0x1654653399040a61",LockedTokens:"0x8d0e87b65159ae63",StakingProxy:"0x62430cf28c26d095",FlowStakingCollection:"0x8d0e87b65159ae63",FUSD:"0x3c5959b568896393"}},f={emulator:{},testnet:{},mainnet:{}},p=e=>{for(const t of Object.keys(f)){const n=e[t],{name:r}=e;f[t]=l({},f[t],"object"==typeof e[t]?n:{[r]:n})}},w={mainnet:"https://access-mainnet-beta.onflow.org",testnet:"https://access-testnet.onflow.org",emulator:"http://localhost:8080"},m=async()=>{const t=await(async()=>await e().get("ix.env")||"emulator")();return l({},d[t]||d.emulator,f[t]||f.emulator)},g=async(t="emulator",n={})=>{const r=t.toLowerCase();if(!d[r])throw new Error(`Provided value "${r}" is not supported. Try "emulator", "testnet" or "mainnet". Default: "emulator"`);const{port:o,endpoint:a,limit:s,extend:c}=n,i=a||("emulator"===r&&o?`http://localhost:${o}`:w[r]);await e().put("ix.env",r),s&&await e().put("ix.executionLimit",s),c&&p(c),await e().put("accessNode.api",i)},x=e=>e.split(/\s/).map(e=>e.replace(/\s/g,"")).filter(e=>e.length>0&&"import"!==e&&"from"!==e),y=(e,t)=>{const[n,r]=t;return e[n]=r,e},h=e=>e&&0!==e.length?e.split("\n").filter(e=>e.includes("import")).map(x).reduce(y,{}):{},b=(e,t={})=>{const n=h(e),r=[];for(const e in n)!t[e]&&Object.prototype.hasOwnProperty.call(n,e)&&r.push(e);return r},v=(e=[],t="")=>{const n="Missing imports for contracts:";console.error(t?`${t} ${n}`:n,e)},k=(e,t,n="")=>{const r=b(e,t);r.length>0&&v(r,n)},F=/(\s*import\s*)([\w\d]+)(\s+from\s*)([\w\d".\\/]+)/g,$=(e,t,n=!0)=>e.replace(F,(e,r,o,a,s)=>{const c=n?o:s;return`${r}${o} from ${(t instanceof Function?t(c):t[c])||s}`}),S=["public","private","storage"],E=e=>{const[t]=e.split("");return t.toUpperCase()+e.slice(1)},I=e=>e.replace(/-/g,"_").split("_").map((e,t)=>t>0?E(e):e).join(""),T=(e,t,n)=>n?e.replace(t,"").split(n):e.replace(t,"").split(N(e)),N=e=>{switch(!0){case e.indexOf("//")>=0:return"//";case e.indexOf("/")>=0:return"/";case e.indexOf("\\")>=0:return"\\";default:return""}},P=e=>e.replace(/\s+/g," "),A="contract",B="transaction",C="script",j=e=>e.split(",").map(e=>e.replace(/\s*/g,"")).filter(e=>""!==e),D=e=>e.replace(/(\/\*[\s\S]*?\*\/)|(\/\/.*)/g,""),L=(e,t)=>{const n=D(e),r=P(n.replace(/[\n\r]/g,""));if(r){const e=new RegExp(t,"g").exec(r);if(e)return""===e[1]?[]:j(e[1])}return[]},O=e=>L(e,"(?:prepare\\s*\\(\\s*)([^\\)]*)(?:\\))"),U=e=>L(e,"(?:fun\\s+main\\s*\\(\\s*)([^\\)]*)(?:\\))"),q=e=>L(e,"(?:transaction\\s*\\(\\s*)([^\\)]*)(?:\\))"),K=e=>M(e).contractName,M=e=>{const t=D(e).replace(/(resource|struct)\s+\w+\s*{[\s\S]+?}/g,""),n=/(?:access\(\w+\)|pub)\s+contract\s+(?:interface)*\s*(\w*)(\s*{[.\s\S]*init\s*\((.*?)\)[.\s\S]*})?/g.exec(t);if(!n||n.length<2)throw new Error("Contract Error: can't find name of the contract");return{contractName:n[1],args:n[3]||""}},R=e=>{const t=D(e);if(/transaction\s*(\(\s*\))*\s*/g.test(t)){const e=O(t),n=q(t);return{type:"transaction",signers:e.length,args:n}}if(/pub\s+fun\s+main\s*/g.test(t))return{type:"script",args:U(t)};if(/\w+\s+contract\s+(\w*\s*)\w*/g.test(t)){const{contractName:e,args:n}=M(t);return{type:"contract",signers:1,args:n,contractName:e}}return{type:"unknown"}},_=e=>e.match(/\/{3}\s*pragma\s*(.*)/g).reduce((e,t)=>{const n=t.match(/\/{3}\s*pragma\s+(\w*)\s+(.*)/),[,r,o]=n;return e[r]=o,e},{}),G=e=>!e||"string"!=typeof e,H=e=>!G(e)&&(e.startsWith("Int")||e.startsWith("UInt")||e.startsWith("Word")),Q=e=>{if(G(e))return!1;const t=e.replace(/\s/g,"");return t.startsWith("[")&&t.endsWith("]")},z=e=>{if(G(e))return!1;const t=e.replace(/\s/g,"");return t.startsWith("{")&&t.endsWith("}")},W=e=>Q(e)||z(e),J={ARGUMENT:"argument"},V=async e=>{const{type:t}=e,n=await r().get("ix.plugins")||{},o=n[t]||[];await r().put("ix.plugins",l({},n,{[t]:[...o,e]}))},X=async e=>{const t=(await r().get("ix.plugins")||{})[e];return!!(t&&t.length>0)&&t},Y=e=>e.split(/(\w+)\s*:\s*([\w{}[\]:\s?]*)/).filter(e=>""!==e).map(e=>e.replace(/\s*/g,"")),Z=e=>Y(e)[1],ee=e=>/{(.*)}/.exec(e)[1].split(/([^:]*):(.*)/).map(e=>e.replace(/\s/g,"")).filter(e=>e),te=e=>/\[(.*)\]/.exec(e)[1].replace(/\s+/g,""),ne=(e,t,n="")=>{if(t>e){const r=`Incorrect number of arguments: found ${e} of ${t}`;console.error(n?`${n} ${r}`:r)}},re=(e="items",t,n,r="")=>{if(n!==t){const o=`Incorrect number of ${e}: found ${t} of ${n}`;console.error(r?`${r} ${o}`:o)}},oe=e=>!G(e)&&(e.includes("?")?t.Optional(t[(e=>e.slice(0,-1))(e)]):t[e]),ae=e=>{if(W(e))switch(!0){case Q(e):{const n=te(e);return t.Array(ae(n))}case z(e):{const[n,r]=ee(e),o={key:ae(n),value:ae(r)};return t.Dictionary(o)}default:return oe(e)}return oe(e)},se=async(e,t)=>{const r=await X(J.ARGUMENT);let o=t,a=e;if(r){let n=await(async(e,t)=>{let n=e.type,r=e.value;for(let e=0;e<t.length;e++){const{resolver:o}=t[e],a=await o(n,r);n=a.type,r=a.value}return{type:n,value:r}})({type:e,value:t},r);o=n.value,a=n.type}const s=ae(a);switch(!0){case(e=>{if(G(e))return!1;let t=e.endsWith("?")?e.slice(0,-1):e;return H(t)||(e=>"String"===e)(t)||(e=>"Character"===e)(t)||(e=>"Bool"===e)(t)})(a):return n.arg(o,s);case(e=>!G(e)&&(e.startsWith("Fix64")||e.startsWith("UFix64")))(a):return null===o?n.arg(null,s):(isNaN(parseFloat(o))&&(e=>{throw new Error("Type Error: Expected proper value for fixed type")})(),n.arg(parseFloat(o).toFixed(8),s));case(e=>"Address"===e||"Address?"===e)(a):{const e=null==(c=o)?null:"0x"+(e=>null==e?null:e.replace(/^0x/,""))(c);return n.arg(e,s)}case(e=>"Path"===e||"Path?"===e)(a):return n.arg((e=>{if(e.startsWith("/")){const t=e.slice(1).split("/");if(2!==t.length)throw Error("Incorrect Path - identifier missing");if(!S.includes(t[0]))throw Error("Incorrect Path - wrong domain");const[n,r]=t;return{domain:n,identifier:r}}throw Error("Incorrect Path - shall start with `/`")})(o),s);case Q(a):{const e=te(a);if(W(e)){const t=await Promise.all(o.map(async t=>{const{value:n}=await se(e,t);return n}));return n.arg(t,s)}return n.arg(o,s)}case z(a):{const[e,t]=ee(a),r=[],c=Object.keys(o);for(let n=0;n<c.length;n++){const a=c[n];let s;s=W(t)?(await se(t,o[a])).value:o[a];const i=H(e)?parseInt(a):a;r.push({key:i,value:s})}return n.arg(r,s)}default:throw`${a} is not supported`}var c},ce=async(e=[],t)=>{if(e.length>t.length)throw new Error("Not enough arguments");return Promise.all(t.map(async(t,n)=>{const r=await se(e[n],t);var o;return(o=r).xform.asArgument(o.value),r}))},ie=async(e,t=[])=>{const n=R(e).args.map(Z);return ce(n,t)},ue=async(e,t)=>{if(0===e.length)return[];const r=e[0];return Array.isArray(r)&&r.length>0&&r[r.length-1].asArgument?(e=>e.reduce((e,t)=>[...e,...((e,t)=>{const r=e[e.length-1];return e.slice(0,-1).map(e=>((e,t)=>n.arg(e,t))(e,r))})(t)],[]))(e):ie(t,e)},le=23830813,de=16,fe=e=>null==e?null:e.replace(/^0x/,""),pe=async()=>o([a(!0)]).then(s),we=async()=>(await pe()).height,me=e=>{const{address:t,contractName:n,eventName:r}=e;return`A.${fe(t)}.${n}.${r}`},ge=async(e,t)=>{if(!e.address)throw"contract shall have address field";if(!e.contractName)throw"contract shall have contractName field";if(!e.eventName)throw"contract shall have event name";let n,r;return t?(r=t.to,n=t.from,t.to||(r=await we()),t.from||(n=r-249)):(r=await we(),n=r-249,n<le&&(console.warn(`"from" value of range is lower than current spork root. setting to ${le}`),n=le)),r<le&&(console.warn(`"to" value of range is lower than current spork root. setting to ${le}`),r=le),n<le&&(console.warn(`"from" value of range is lower than current spork root. setting to ${le}`),n=le),o([c(me(e),n,r)]).then(s)},xe=async(e,t={})=>{const{step:n=200,delay:r=500,start:o=null,maxRange:a=Infinity,sporkLimit:s=le}=t;let c=n,i=o||await we(),u=i-n;return i<s&&(console.warn(`"to" value of range is lower than current spork root. setting to ${le}`),i=s),u<s&&(console.warn(`"from" value of range is lower than current spork root. setting to ${le}`),u=s),new Promise((t,o)=>{setTimeout(async function s(){try{console.log(`${u} -> ${i}...`);const o=await ge(e,{from:u,to:i});0!==o.length?(clearInterval(void 0),t({events:o})):(c>a&&t({events:o,latestBlock:i}),i=u,u-=n,c+=n,setTimeout(s,r))}catch(e){o({events:[],err:e,latestBlock:i})}},r)})},ye=new i("p256"),he=(e,t)=>{const n=ye.keyFromPrivate(Buffer.from(e,"hex")).sign((e=>{const t=new u(256);return t.update(Buffer.from(e,"hex")),t.digest()})(t)),r=n.r.toArrayLike(Buffer,"be",32),o=n.s.toArrayLike(Buffer,"be",32);return Buffer.concat([r,o]).toString("hex")},be=e=>{if("object"==typeof e){if(void 0===e.privateKey)throw Error("privateKey is required");if(void 0===e.address)throw Error("address is required");void 0===e.keyId&&console.warning(`key index have incorrect format. found '${typeof e.keyId}', required 'num'`);const{address:t,privateKey:r,keyId:o=0}=e;return((e,t,r=0)=>async(o={})=>l({},o,{tempId:`${e=fe(e)}-${r}`,addr:n.sansPrefix(e),keyId:r,signingFunction:async n=>{return{keyId:r,addr:(o=e,null==o?null:"0x"+fe(o)),signature:he(t,n.message)};var o}}))(t,r,o)}return e},ve=async(t,r)=>{const{code:o,cadence:a,args:s,addressMap:c,limit:i,processed:u}=t,d=o||a,f=l({},await m(),c),p=u?d:$(d,f),w="script"===r?[n.script(p)]:[n.transaction(p)];if(s){const e=await ue(s,d);w.push(n.args(e))}const g=await e().get("ix.executionLimit");if(w.push(n.limit(i||g||100)),"transaction"===r){const{proposer:e,payer:r,signers:o=[]}=t,a=0===o.length?[r]:o,s=e||r;w.push(n.payer(be(r))),w.push(n.proposer(be(s))),w.push(n.authorizations(a.map(be)))}return n.send(w)},ke=async e=>{const{raw:t=!1}=e;try{const r=await ve(e,"script");return t?[r.encodedData,null]:[await n.decode(r),null]}catch(e){return[null,e]}},Fe=async e=>{const{wait:t="seal"}=e;try{const r=await ve(e,"transaction");if(t){const e=(e=>{if("string"==typeof e){const t=e.toLowerCase();if(t.includes("final"))return"onceFinalized";if(t.includes("exec"))return"onceExecuted";if(t.includes("seal"))return"onceSealed"}return console.log(`⚠️ [33mStatus value [1m[35m"${e}"[33m[2m is not supported. Reverting to [32m"onceSealed"[0m`),"onceSealed"})(t);return[l({txId:r},await n.tx(r)[e]()),null]}return[r.transactionId,null]}catch(e){return[null,e]}},$e=async e=>{const{name:t,to:n,payer:r,proposer:o,code:a,update:s=!1,processed:c=!1,addressMap:i={}}=e,u=c?a:$(a,i),l=s?"\n    transaction(name: String, code: String) {\n      prepare(acct: AuthAccount){\n        let decoded = code.decodeHex()\n        \n        acct.contracts.add(\n          name: name,\n          code: decoded,\n        )\n      }\n    }\n  ":"\n  transaction(name: String, code: String){\n    prepare(acct: AuthAccount){\n      let decoded = code.decodeHex()\n      \n      if acct.contracts.get(name: name) == nil {\n        acct.contracts.add(name: name, code: decoded)\n      } else {\n        acct.contracts.update__experimental(name: name, code: decoded)\n      }\n    }\n  }\n",d=Buffer.from(u,"utf8").toString("hex");let f=n,p=n;return r&&(p=r,f=o||r),Fe({payer:p,proposer:f,signers:[n],code:l,args:[t,d]})},Se=async e=>$e(l({},e,{update:!0}));export{A as CONTRACT,de as CURRENT_SPORK_NUMBER,le as CURRENT_SPORK_ROOT,J as PLUGIN_TYPES,C as SCRIPT,B as TRANSACTION,Z as argType,E as capitalizeFirstLetter,P as collapseSpaces,$e as deployContract,ke as executeScript,p as extendEnvironment,L as extract,K as extractContractName,M as extractContractParameters,h as extractImports,U as extractScriptArguments,O as extractSigners,q as extractTransactionArguments,xe as findLatestEvents,j as generateSchema,te as getArrayType,we as getChainHeight,ee as getDictionaryTypes,m as getEnvironment,me as getEventName,ge as getEventsInRange,pe as getLatestBlock,X as getPlugins,_ as getPragmaNotes,N as getSplitCharacter,R as getTemplateInfo,se as mapArgument,ce as mapArguments,ie as mapValuesToCode,b as missingImports,Fe as mutate,ke as query,V as registerPlugin,$ as replaceImportAddresses,v as report,ne as reportArguments,re as reportMissing,k as reportMissingImports,ue as resolveArguments,Fe as sendTransaction,g as setEnvironment,Y as splitArgs,D as stripComments,T as trimAndSplit,I as underscoreToCamelCase,Se as updateContract};
//# sourceMappingURL=main.modern.js.map
